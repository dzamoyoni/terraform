# Tenant Isolation Network Policies
# Compatible with istioctl-deployed Istio service mesh
# Provides defense-in-depth with both NetworkPolicy and Istio policies

---
# Base Network Policy Template for Each Tenant Namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: tenant-isolation-base
  namespace: ezra-client-a  # Replace with actual tenant namespace
  labels:
    tenant: ezra
    policy-type: isolation
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  
  # Allow ingress from same namespace
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          tenant: ezra  # Same tenant label
    ports:
    - protocol: TCP
      port: 8080
    - protocol: TCP
      port: 8443
    - protocol: TCP
      port: 9090
  
  # Allow ingress from Istio system components
  - from:
    - namespaceSelector:
        matchLabels:
          name: istio-system
  
  # Allow ingress from monitoring namespace (if exists)
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
  
  egress:
  # Allow egress to same namespace
  - to:
    - namespaceSelector:
        matchLabels:
          tenant: ezra
  
  # Allow egress to Istio system
  - to:
    - namespaceSelector:
        matchLabels:
          name: istio-system
  
  # Allow egress to kube-system for DNS
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
  
  # Allow egress to external services (can be restricted further)
  - to: []
    ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 80

---
# MTN Ghana Tenant Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: tenant-isolation-base
  namespace: mtn-ghana-client  # Replace with actual MTN Ghana namespace
  labels:
    tenant: mtn-ghana
    policy-type: isolation
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          tenant: mtn-ghana
    ports:
    - protocol: TCP
      port: 8080
    - protocol: TCP
      port: 8443
    - protocol: TCP
      port: 9090
  
  - from:
    - namespaceSelector:
        matchLabels:
          name: istio-system
  
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
  
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          tenant: mtn-ghana
  
  - to:
    - namespaceSelector:
        matchLabels:
          name: istio-system
  
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
  
  - to: []
    ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 80

---
# Deny All Cross-Tenant Communication Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: deny-cross-tenant-communication
  namespace: ezra-client-a
  labels:
    tenant: ezra
    policy-type: deny-cross-tenant
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  
  # Explicitly deny ingress from other tenant namespaces
  ingress:
  - from:
    - namespaceSelector:
        matchExpressions:
        - key: tenant
          operator: In
          values: ["ezra"]
        - key: name
          operator: In
          values: ["istio-system", "kube-system", "monitoring"]

---
# Gateway Access Policy - Allow ingress gateway traffic
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-istio-gateway
  namespace: ezra-client-a
  labels:
    tenant: ezra
    policy-type: gateway-access
spec:
  podSelector:
    matchLabels:
      app: your-app  # Replace with your app labels
  policyTypes:
  - Ingress
  
  ingress:
  # Allow from Istio ingress gateway
  - from:
    - namespaceSelector:
        matchLabels:
          name: istio-system
    - podSelector:
        matchLabels:
          app: istio-ingressgateway
    ports:
    - protocol: TCP
      port: 8080
