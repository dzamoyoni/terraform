# Istio Authorization Policies for Tenant Isolation
# Compatible with istioctl-deployed Istio service mesh
# Works alongside Kubernetes NetworkPolicies for defense-in-depth

---
# Default Deny Policy for Ezra Tenant
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: deny-all-default
  namespace: ezra-client-a
  labels:
    tenant: ezra
    policy-type: default-deny
spec:
  # Empty spec means deny all by default

---
# Allow Intra-Tenant Communication for Ezra
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-intra-tenant
  namespace: ezra-client-a
  labels:
    tenant: ezra
    policy-type: allow-intra-tenant
spec:
  rules:
  - from:
    - source:
        namespaces: ["ezra-client-a"]
    - source:
        namespaces: ["istio-system"]
  - to:
    - operation:
        methods: ["GET", "POST", "PUT", "DELETE", "PATCH"]

---
# Allow Istio Gateway Access for Ezra
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-istio-gateway
  namespace: ezra-client-a
  labels:
    tenant: ezra
    policy-type: gateway-access
spec:
  rules:
  - from:
    - source:
        principals: ["cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account"]
  - to:
    - operation:
        methods: ["GET", "POST", "PUT", "DELETE"]

---
# Default Deny Policy for MTN Ghana Tenant
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: deny-all-default
  namespace: mtn-ghana-client
  labels:
    tenant: mtn-ghana
    policy-type: default-deny
spec:
  # Empty spec means deny all by default

---
# Allow Intra-Tenant Communication for MTN Ghana
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-intra-tenant
  namespace: mtn-ghana-client
  labels:
    tenant: mtn-ghana
    policy-type: allow-intra-tenant
spec:
  rules:
  - from:
    - source:
        namespaces: ["mtn-ghana-client"]
    - source:
        namespaces: ["istio-system"]
  - to:
    - operation:
        methods: ["GET", "POST", "PUT", "DELETE", "PATCH"]

---
# Allow Istio Gateway Access for MTN Ghana
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-istio-gateway
  namespace: mtn-ghana-client
  labels:
    tenant: mtn-ghana
    policy-type: gateway-access
spec:
  rules:
  - from:
    - source:
        principals: ["cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account"]
  - to:
    - operation:
        methods: ["GET", "POST", "PUT", "DELETE"]

---
# Cross-Tenant Denial Policy (Applied at Root Level)
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: deny-cross-tenant
  namespace: istio-system
  labels:
    policy-type: cross-tenant-deny
spec:
  selector:
    matchLabels:
      app: istio-proxy
  rules:
  # Explicitly deny communication between different tenants
  - from:
    - source:
        namespaces: ["ezra-client-a"]
    to:
    - operation:
        hosts: ["*.mtn-ghana-client.svc.cluster.local"]
    when:
    - key: request.headers[tenant]
      notValues: ["mtn-ghana"]
  
  - from:
    - source:
        namespaces: ["mtn-ghana-client"]
    to:
    - operation:
        hosts: ["*.ezra-client-a.svc.cluster.local"]
    when:
    - key: request.headers[tenant]
      notValues: ["ezra"]

---
# Allow Health Checks and Metrics
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-health-metrics
  namespace: ezra-client-a
  labels:
    tenant: ezra
    policy-type: observability
spec:
  rules:
  - to:
    - operation:
        paths: ["/health", "/metrics", "/ready", "/live"]
        methods: ["GET"]

---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-health-metrics
  namespace: mtn-ghana-client
  labels:
    tenant: mtn-ghana
    policy-type: observability
spec:
  rules:
  - to:
    - operation:
        paths: ["/health", "/metrics", "/ready", "/live"]
        methods: ["GET"]
